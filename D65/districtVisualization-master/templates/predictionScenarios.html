<!DOCTYPE html>

<!-- Notes

This page represents the home page of the interactive modeling tool. It primarily focuses
on displaying data that is very general and applies to the whole district. For example, it
displays the population density of the entire district by highlighting blocks a particular color,
if a certain race/ethnic group is the majority in that block. It also displays population densities by
various demographics among the blocks that were reassigned as a result of the most recent optimization model
results. Additionally, it displays a population density by the amount of students in a block that bused for
the distance from the block to their assigned school. The page can also direct a user to other parts of the tool,
such as being able to navigate to a page that has other pages to represent data analytics pertaining to specific schools.


//School district boundaries/Numbering System
// 0 - Dawes
// 1 - Dewey
// 2 - Kingsley
// 3 - Lincoln
// 4 - Lincolnwood
// 5 - Oakton
// 6 - Orrington
// 7 - Walker
// 8 - Washington
// 9 - Willard
// 10 - Bessie Rhodes
// 11 - MLK

=====
Feeders for Middle Schools:

Chute: Dawes, Oakton, Walker
Haven: Willard, Lincolnwood, Kingsley, Orrington
Nichols: Washington, Dewey, Lincoln
=====

Most buttons can be added to the map using this skeleton:

   <div class='map-overlay-button (put specific button name here)'>
    	<div class='map-overlay-inner-button'>
        	<fieldset>
            	<label>(put actual button name here, the name the user will see)</label>
            	<button id=" (put a name for the button here, a short one that you can refer to in the file)"></button>
        	</fieldset>
    	</div>
   </div>

=====================================================
=====================================================
To change the color of the blocks via mapbox style function calls, use this command:

 map.setPaintProperty("blocks", 'fill-color', (put values here));  Here is an example:

 map.setPaintProperty("blocks", 'fill-color', ["case",
         ["==", ["number", ['get', 'busedHazard']],
             300], "transparent",//not in district
         ["==", ["number", ['get', 'busedDistance']],
             0], "#fef0d9", //light white
         ["<", ["number", ['get', 'busedDistance']],
             1], "#fdcc8a",
         ["<", ["number", ['get', 'busedDistance']],
             2], "#fc8d59",
         ["<", ["number", ['get', 'busedDistance']],
             3], "#e34a33", //orange
         /* > 3 */  "#b30000"]);//dark red

Notice that a color appears in this kind of format: a string with numbers and letters, like  "#fef0d9"

Notice that the color values differ for different boolean cases. Go to this link to learn how to write
these special mapbox expressions which look like Racket code from CS 111: https://docs.mapbox.com/mapbox-gl-js/style-spec/


When retrieving a property from the blocks for the purpose of changing the colors of some blocks,
you'll notice that there are a lot of expressions like ['number', ['get', (some property name here)]]

That retrieves the property from each block and converts it into a number (if it is able to be converted into a number)

=====================================================
=====================================================
JavaScript function syntax:

function function_name( put parameters/arguments/inputs here)
{
  put function body code here, JS functions DO NOT NEED return statements

}



=====================================================
=====================================================
Clearing and filling the dynamic legend (the transparent
box that has color blocks with descriptions
for each block)

--- This while loop clears the "data" currently inside of the
legend

while (legend.hasChildNodes()) {
         legend.removeChild(legend.firstChild);
     }

--- Replace the strings inside of the layers array with the various descriptions you want for the legend
and replace the colors array with the corresponding colors for the descriptions

     var layers = ['Zero students', 'One Student', 'Two Students', 'Three Students', 'Greater than Three Students'];
     var colors = ["#fef0d9", "#fdcc8a", "#fc8d59", "#e34a33", "#b30000"];

--- This for loop adds each color and layer to the legend by creating HTML elements on the go

     for (i = 0; i < layers.length; i++) {
         var layer = layers[i];
         var color = colors[i];
         var item = document.createElement('div');
         var key = document.createElement('span');
         key.className = 'legend-key';
         key.style.backgroundColor = color;

         var value = document.createElement('span');
         value.innerHTML = layer;
         item.appendChild(key);
         item.appendChild(value);
         legend.appendChild(item);
     }


=====================================================
=====================================================
Most hovering drop down lists/menus can be added using
this skeleton (each menu needs its own set of classes. Look at the css
 file for any of the pages that has a dropdown menu to see an example of how to do this correctly.
 It is really just copy and paste):

    <div class="dropdown">
      <button class="dropbtn"> (put menu title here) </button>
      <div class="dropdown-content">
       --You can use the <a> tag for calling JS functions or hyperlinks: <a onclick=" (function name here) ">(button title here)</a>
        <a onclick=" (function name here) ">(button title here)</a>
        <a onclick=" (function name here) ">(button title here)</a>
          and so on...
      </div>
    </div>

You can also use something like this to link a button in a drop-down menu to a hyperlink:

<a href="http://127.0.0.1:5000/SchoolAssignment">School Assignment & Demographics</a>


-->
<html>
<head>
    <meta charset='utf-8' />
    <title>D65</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.46.0/mapbox-gl.js'></script>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <!-- <script src="../static/mapVisual.js"></script> -->
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.46.0/mapbox-gl.css' rel='stylesheet' />
    <link rel="stylesheet" type="text/css" href="../static/predictionScenarios.css">
    <!-- CSS information for the map -->
    <style>
      body { margin:0; padding:0; }
      #map { position:absolute; top:40px; bottom:0; width:100%; }
    </style>
</head>
<body>

<!-- HTML -->

<div id='nav_bar'></div>
<div id="map"></div>
<div class='map-overlay-legend All' id='legend'> </div>


        <div class='map-overlay slider1'>
            <div class='map-overlay-inner'>
                <h2>Projections Slider</h2>
                    <label id='month1'></label>
                        <input id='slider1' type='range' min='18' max='28' step='5' value='18' />
                </div>

             <div class='map-overlay-inner'>
                <div id='legend4' class="legend4">
                    <div class='bar4'></div>
                    <div>Enrolled Students</div>
                </div>
            </div>
        </div>





<!-- This form represents the input box for the optimization model -->
    <form method = "post" id='paramInput' class="map-overlay optimizationButton">
      Maximum % of blocks reassigned (1-100)
        <br>
      <input type="text" id="blocksAssigned" >
      <br>

      Objective scaling factor: average student travel distance (km) (>= 0) <br>
      <input type="text" id="travelDistance"> <br>


      Objective scaling factor: expected yearly # of excess students per school (>=0)<br>
      <input type="text" id="excessStudents"> <br>

        Objective scaling factor: expected yearly # of students bussed (>=0)<br>
      <input type="text" id="studentsBussed"> <br>

        Objective scaling factor: expected yearly # of busses used per school (>= 0)<br>
      <input type="text" id="yearlyBusPerSchool"> <br>

        Objective scaling factor: # of Title 1 eligible schools (>=0)<br>
      <input type="text" id="titleOneEligibleSchools"> <br>

       <label id="contiguity"> Require Contiguity? </label><br>
      <input type="checkbox" name="contiguity" id='myCheckbox'> <br>

      <input type="button" value="Run Optimization" id="optimizationButton">
    </form>



    <!-- The following elements represent drop-down menus for various purposes-->
    <div class="dropdown">
      <button class="dropbtn">Navigate</button>
      <div class="dropdown-content">
        <a onclick="pageDescription()">Page Description</a>
        <a href="http://127.0.0.1:5000/">Home Page</a>
      </div>
    </div>

    <div class="dropdown1">
      <button class="dropbtn1">Metrics</button>
      <div class="dropdown1-content">
        <button class="accordion">Enrollment</button>
            <div class="panel">
                <a onclick="">Sample 1</a>
                <a onclick="">Sample 2</a>
                <a onclick="">Sample 3</a>
                <a onclick="">Sample 4</a>
                <a onclick="">Average</a>
            </div>
          <button class="accordion">Ethinc Majorities</button>
            <div class="panel">
                <a onclick="">Sample 1</a>
                <a onclick="">Sample 2</a>
                <a onclick="">Sample 3</a>
                <a onclick="">Sample 4</a>
                <a onclick="">Average</a>
            </div>
          <button class="accordion">Free/Reduced Lunch</button>
            <div class="panel">
                <a onclick="">Sample 1</a>
                <a onclick="">Sample 2</a>
                <a onclick="">Sample 3</a>
                <a onclick="">Sample 4</a>
                <a onclick="">Average</a>
            </div>
      </div>
    </div>

    <div class="dropdown4">
      <button class="dropbtn4">Legend Toggles</button>
      <div class="dropdown4-content">
        <a onclick="legendToggle()">Show/Hide Color Legend</a>
        <a onclick="optimizationButtonToggle()">Show/Hide Optimization Form</a>
      </div>
    </div>

</body>
</html>


<script type="text/javascript">

///////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////
// Displaying the map

mapboxgl.accessToken = 'pk.eyJ1IjoiZXJpbmJydW5zIiwiYSI6ImNqajV3MG51bjI0MWkzcG1tZXZycjdyZWcifQ.-X9WJp4KZ6VEGrkDQI3A_w';
var map = new mapboxgl.Map(
{
container: 'map', // container id
style: 'mapbox://styles/mapbox/light-v9', // stylesheet location
center: [-87.6877, 42.0451], // starting position [lng, lat]
zoom: 12.7// starting zoom
});

////////////////////////////////////////////////
// Linking the geoJSON files to JavaScript objects
// that the mapbox map object can use
var blocks = { "type": "geojson",
               "data": "./static/blocks.geojson"};

var blockLabels = { "type": "geojson",
                            "data": "./static/blockLabels.geojson"};

var schools = { "type": "geojson",
                            "data": "./static/schools.geojson"};

var schoolNames = ["Dawes", "Dewey", "Kingsley",
                   "Lincoln", "Lincolnwood", "Oakton",
                   "Orrington", "Walker", "Washington",
                   "Willard", "Bessie Rhodes", "MLK"];

var frlCount_by_school = [463, 642, 333, 189, 427, 992, 56, 406, 459, 42, 0, 0];
var twiCount_by_school = [315, 305, 115, 134, 142, 491, 50, 161, 348, 71, 0, 0];
var k_2Count_by_school = [395, 726, 369, 418, 573, 741, 319, 469, 556, 342, 0, 0];
var three_fiveCount_by_School = [448, 698, 466, 429, 573, 825, 281, 442, 518, 353, 0, 0];

// Creating a dynamic variable for creating a popup
// for hovering over blocks/schools
var popup = new mapboxgl.Popup({
        closeButton: false,
        closeOnClick: false
    });


map.on('load', function() {
    map.addSource("blockLabels", blockLabels);
    map.addSource("blocks", blocks);
    map.addSource("schools", schools);


    // //adds labels to map
   /* map.addLayer({"id": "blockLabels",
                 "type": "symbol",
                 "source": "blockLabels",
                 "layout": { "icon-image": "{icon}-11",
                             "icon-allow-overlap": true,
                             "text-field": "{title}",
                             "text-font": ["Open Sans Regular", "Arial Unicode MS Regular"],
                             "text-offset": [0, 0.6],
                             "text-anchor": "top"}
    });
    */
    //adds schools to map
    map.addLayer({"id": "schools",
                "type": "symbol",
                "source": "schools",
                "layout": { "icon-image": "{icon}-11",
                            "icon-allow-overlap": true,
                            "text-field": "{title}",
                            "text-font": ["Open Sans Regular", "Arial Unicode MS Regular"],
                            "text-offset": [0, 0.6],
                            "text-anchor": "top"}
    });

    //adds blocks to map
    map.addLayer({
        "id": "blocks",
        "type": "fill",
        "source": "blocks",
        "layout": {},
        "paint": {
             "fill-color": ['case',
                              ['==', ['number', ['get', 'currentSchool']],
                                     300],
                              "transparent",
                              "#86F"],
             "fill-opacity": 0.5
        }
    });


    // When the user moves their mouse over the state-fill layer, we'll update the
    // feature state for the feature under the mouse.
    map.on("mousemove", "blocks", function(e) {
        if (e.features.length > 0) {
            hoveredStateId = e.features["0"].properties.id;
            map.setPaintProperty('blocks', 'fill-color', ['case',
            ['==', ['number', ['get', 'currentSchool']],
                   300],
            "transparent",
            ['==', ['number', ['get', 'id']],
                   hoveredStateId],
            "#ff8123",
            "#86F"]);
        }
        // Change the cursor style as a UI indicator.
        map.getCanvas().style.cursor = 'pointer';

        var coordinates = e.lngLat;

        // This variable holds all of the information to be displayed when the
        // user hovers over a block
        var description = 'Block ID: '.concat(e.features["0"].properties.id.toString(),
                          ', Current School: ', schoolNames[e.features["0"].properties.currentSchool],
                          ', New School: ', schoolNames[e.features["0"].properties.newSchool],
                          ', Total Students: ', e.features["0"].properties.totalStudentsNum.toString(),
                          ', Free/Reduced Lunch: ', e.features["0"].properties.frlNum);


        // Ensure that if the map is zoomed out such that multiple
        // copies of the feature are visible, the popup appears
        // over the copy being pointed to.
        while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
        coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
        }

        // Populate the popup and set its coordinates
        // based on the feature found.
        popup.setLngLat(coordinates)
        .setHTML(description)
        .addTo(map);

    });

    // When the mouse leaves the state-fill layer, update the feature state of the
    // previously hovered feature, the popup disappears
    map.on("mouseleave", "blocks", function() {
        if (hoveredStateId) {
            map.setPaintProperty('blocks', 'fill-color', "#86F");
        }
        hoveredStateId =  null;
        map.getCanvas().style.cursor = '';
        popup.remove();
    })


});



var hoveredStateId =  null;

//Function that displays a text box with the page description
function pageDescription()
{
    alert('This page represents the home page of the interactive modeling tool. It primarily focuses\n' +
        'on displaying data that is very general and applies to the whole district. For example, it\n' +
        'displays the population density of the entire district by highlighting blocks a particular color,\n' +
        'if a certain race/ethnic group is the majority in that block. It also displays population densities by\n' +
        'various demographics among the blocks that were reassigned as a result of the most recent optimization model\n' +
        'results. Additionally, it displays a population density by the amount of students in a block that bused for\n' +
        'the distance from the block to their assigned school. The page can also direct a user to other parts of the tool,\n' +
        'such as being able to navigate to a page that has other pages to represent data analytics pertaining to specific schools.');
}


var acc = document.getElementsByClassName("accordion");
var i;

for (i = 0; i < acc.length; i++) {
  acc[i].addEventListener("click", function() {
    /* Toggle between adding and removing the "active" class,
    to highlight the button that controls the panel */
    this.classList.toggle("active");

    /* Toggle between hiding and showing the active panel */
    var panel = this.nextElementSibling;
    if (panel.style.display === "block") {
      panel.style.display = "none";
    } else {
      panel.style.display = "block";
    }
  });
}


//////////////////////////////////////////////
// This function highlights block one of two colors
// to represent which blocks are assigned as Title One, and
// which are not, as a result of running the optimization model
function titleOneVisual()
{
    map.setPaintProperty('blocks', 'fill-color', ['case',
        ['==', ['number', ['get', 'currentSchool']],
               300],
        "transparent",
        ['all', ['==', ['number', ['get', 'titleOne']],
                       1],
                ['any', ['==', ['number', ['get', 'currentSchool']],
                           0],
                    ['==', ['number', ['get', 'currentSchool']],
                           1],
                    ['==', ['number', ['get', 'currentSchool']],
                           2],
                    ['==', ['number', ['get', 'currentSchool']],
                           3],
                    ['==', ['number', ['get', 'currentSchool']],
                           4],
                    ['==', ['number', ['get', 'currentSchool']],
                           5],
                    ['==', ['number', ['get', 'currentSchool']],
                           6],
                    ['==', ['number', ['get', 'currentSchool']],
                           7],
                    ['==', ['number', ['get', 'currentSchool']],
                           8],
                    ['==', ['number', ['get', 'currentSchool']],
                           9],
                    ['==', ['number', ['get', 'currentSchool']],
                           10],
                    ['==', ['number', ['get', 'currentSchool']],
                           11]]],
        "#2B8C83",
        "#DECC46"
    ]);

    while (legend.hasChildNodes()) {
         legend.removeChild(legend.firstChild);
     }

     var layers = ['Title One', 'Not Title One'];
     var colors = ["#2B8C83", "#DECC46"];

     var label = document.createElement('label');
     label.innerHTML = 'Title One Schools';
     legend.appendChild(label);

     for (i = 0; i < layers.length; i++) {
         var layer = layers[i];
         var color = colors[i];
         var item = document.createElement('div');
         var key = document.createElement('span');
         key.className = 'legend-key';
         key.style.backgroundColor = color;

         var value = document.createElement('span');
         value.innerHTML = layer;
         item.appendChild(key);
         item.appendChild(value);
         legend.appendChild(item);
     }
}


legendOff();
optimizationButtonOff();





///////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////
// Functions for the optimization model button, to display it or hide it
function optimizationButtonOn()
{
    var optimizationButtonObj = document.getElementById('optimizationButton');
    optimizationButtonObj.style.display = "block";

    var paramInputObj = document.getElementById('paramInput');
    paramInputObj.style.display = "block";
}
function optimizationButtonOff()
{
    var optimizationButtonObj = document.getElementById('optimizationButton');
    optimizationButtonObj.style.display = "none";

    var paramInputObj = document.getElementById('paramInput');
    paramInputObj.style.display = "none";
}

function  optimizationButtonToggle()
{
    var optimizationButtonObj = document.getElementById('optimizationButton');
    var paramInputObj = document.getElementById('paramInput');

    ///////////////////////////////////////////////////////

    if (optimizationButtonObj.style.display === "none" &&  paramInputObj.style.display === "none") {
        optimizationButtonObj.style.display = "block";
        paramInputObj.style.display = "block";
    }
    else {
        optimizationButtonObj.style.display = "none";
        paramInputObj.style.display = "none";
    }
}



///////////////////////////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////
// Functions for the legend, to display or hide it
function legendOn()
{
    var legendObj = document.getElementById('legend');
    legendObj.style.display = "block";
}
function legendOff()
{
    var legendObj = document.getElementById('legend');
    legendObj.style.display = "none";
}

function  legendToggle()
{
    var legendObj = document.getElementById('legend');
    if (legendObj.style.display === "none")
        legendObj.style.display = "block";
    else
        legendObj.style.display = "none";
}


//Adding a kind-of-sort-of event listener, so that
//when a user inputs numbers into the input box,
//the appropiate functions are called
$('#optimizationButton').on('click', function(){
            alert('The Optimization Model is about to start running! Click OK to let it run');
            var blocksAssigned = $('#blocksAssigned').val();
            var travelDistance = $('#travelDistance').val();
            var excessStudents = $('#excessStudents').val();
            var studentsBussed = $('#studentsBussed').val();
            var yearlyBusPerSchool = $('#yearlyBusPerSchool').val();
            var titleOneEligibleSchools = $('#titleOneEligibleSchools').val();

            console.log("clicked");
            
            if ( $('input[name="contiguity"]').is(':checked') ) {
                var contiguity = 1; 
            }
            else{
                var contiguity = 0; 
            }
             $.ajax({
                url: 'http://127.0.0.1:5000/square/',
                data: {'blocksAssigned': blocksAssigned,
                       'travelDistance': travelDistance,
                       'excessStudents': excessStudents,
                       'studentsBussed': studentsBussed,
                       'yearlyBusPerSchool': yearlyBusPerSchool,
                       'titleOneEligibleSchools': titleOneEligibleSchools,
                       'contiguity': contiguity},
                method: 'POST',
                success: function() {
                    $('#blocksAssigned').val('');
                    $('#travelDistance').val('');
                    $('#excessStudents').val('');
                    $('#studentsBussed').val('');
                    $('#yearlyBusPerSchool').val('');
                    $('#titleOneEligibleSchools').val('');
                    $('#myCheckbox').prop('checked', false);
                    console.log("success");
                    alert('The Optimization Model has finished running!');
                }
            });
        });

///////////////////////////////////////////////
///////////////////////////////////////////////
//Function that displays a population density based off of bused for distance or hazards
 function distance_or_hazard(busType) {

     map.setPaintProperty("blocks", 'fill-color', ["case",
         ["==", ["number", ['get', 'bused' + busType]],
             300], "transparent",//not in district
         ["==", ["number", ['get', 'bused' + busType]],
             0], "#fef0d9", //light white
         ["<", ["number", ['get', 'bused' + busType]],
             1], "#fdcc8a",
         ["<", ["number", ['get', 'bused' + busType]],
             2], "#fc8d59",
         ["<", ["number", ['get', 'bused' + busType]],
             3], "#e34a33", //orange
         /* > 3 */  "#b30000"]);//dark red

     while (legend.hasChildNodes()) {
         legend.removeChild(legend.firstChild);
     }

     var layers = ['Zero students', 'One Student', 'Two Students', 'Three Students', 'Greater than Three Students'];
     var colors = ["#fef0d9", "#fdcc8a", "#fc8d59", "#e34a33", "#b30000"];

     var label = document.createElement('label');
     label.innerHTML = 'Students Bused for ' + busType;
     legend.appendChild(label);

     for (i = 0; i < layers.length; i++) {
         var layer = layers[i];
         var color = colors[i];
         var item = document.createElement('div');
         var key = document.createElement('span');
         key.className = 'legend-key';
         key.style.backgroundColor = color;

         var value = document.createElement('span');
         value.innerHTML = layer;
         item.appendChild(key);
         item.appendChild(value);
         legend.appendChild(item);
     }
 }


///////////////////////////////////////////////
///////////////////////////////////////////////
//Function that displays a population density by the current or new school assignments
    function assignmentVisual(givenMode) {
        var label = document.createElement('label');

        if (givenMode === 'current') {
            map.setPaintProperty("blocks", 'fill-color', ["match", ["number", ['get', 'currentSchool']],
                0, "#228B22",
                1, "#7FFF00",
                2, "#FFFF00",
                3, "#FFA500",
                4, "#4410bc",
                5, "#6BE144",
                6, "#d1503c",
                7, "#DA3CDC",
                8, "#ABABAB",
                9, "#19E2D1",
                10, "#111111",
                11, "#987234",
                12, "#ABCDE1",
                /*not in district (current school is set to 300)*/  "transparent"]);
            label.innerHTML = 'Current School Assignments';

            map.on("mousemove", "blocks", function (e) {
                if (e.features.length > 0) {
                    hoveredStateId = e.features["0"].properties.id;
                    map.setPaintProperty('blocks', 'fill-color', ['case',
                        ['==', ['number', ['get', 'currentSchool']],
                            300],
                        "transparent",
                        ['==', ['number', ['get', 'currentSchool']],
                            e.features["0"].properties.currentSchool],
                        "#ff8123",
                        "#86F"]);
                }
                // Change the cursor style as a UI indicator.
                map.getCanvas().style.cursor = 'pointer';

                var coordinates = e.lngLat;

                // obtains the school of the hovered block and stores it,
                // to use for indexing in various arrays that contain data
                // about each school
                schoolCountsIndex = e.features["0"].properties.currentSchool;
                totalCount = k_2Count_by_school[schoolCountsIndex] + three_fiveCount_by_School[schoolCountsIndex];

                // this description holds all of the information to be
                // displayed for a school when any of its blocks become
                // hovered
                var description = 'School: '.concat(schoolNames[e.features["0"].properties.currentSchool],
                    ', Total Students: ', totalCount.toString(),
                    ', TWI: ', twiCount_by_school[schoolCountsIndex].toString(),
                    ', Free/Reduced Lunch: ', frlCount_by_school[schoolCountsIndex].toString());


                // Ensure that if the map is zoomed out such that multiple
                // copies of the feature are visible, the popup appears
                // over the copy being pointed to.
                while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
                    coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
                }

                // Populate the popup and set its coordinates
                // based on the feature found.
                popup.setLngLat(coordinates)
                    .setHTML(description)
                    .addTo(map);

            });

            // When the cursor leaves the block, set the configuration
            // of the map back to its default assignment
            map.on("mouseleave", "blocks", function () {
                map.setPaintProperty("blocks", 'fill-color', ["match", ["number", ['get', 'currentSchool']],
                    0, "#228B22",
                    1, "#7FFF00",
                    2, "#FFFF00",
                    3, "#FFA500",
                    4, "#4410bc",
                    5, "#6BE144",
                    6, "#d1503c",
                    7, "#DA3CDC",
                    8, "#ABABAB",
                    9, "#19E2D1",
                    10, "#111111",
                    11, "#987234",
                    12, "#ABCDE1",
                    /*not in district (current school is set to 300)*/  "transparent"]);
                hoveredStateId = null;
                map.getCanvas().style.cursor = '';
                popup.remove();
            });

            label.innerHTML = 'Current School Assignments';
        }
        else {
            map.setPaintProperty("blocks", 'fill-color', ["match", ["number", ['get', 'newSchool']],
                0, "#228B22",
                1, "#7FFF00",
                2, "#FFFF00",
                3, "#FFA500",
                4, "#4410bc",
                5, "#6BE144",
                6, "#d1503c",
                7, "#DA3CDC",
                8, "#ABABAB",
                9, "#19E2D1",
                10, "#111111",
                11, "#987234",
                12, "#ABCDE1",
                /*not in district (current school is set to 300)*/  "transparent"]);
            label.innerHTML = 'New School Assignments';
        }
        while (legend.hasChildNodes()) {
            legend.removeChild(legend.firstChild);
        }

        let layers = ['Dawes', 'Dewey', 'Kingsley', 'Lincoln', 'Lincolnwood', 'Oakton',
            'Orrington', 'Walker', 'Washington', 'Willard', 'Bessie Rhodes', 'MLK'];

        let colors = ["#228B22", //dark green
            "#7FFF00", //light green
            "#FFFF00", //yellow
            "#FFA500", //orange
            "#4410bc",
            "#6BE144",
            "#d1503c",
            "#DA3CDC",
            "#ABABAB",
            "#19E2D1",
            "#111111",
            "#987234",
            "#ABCDE1",];


        legend.appendChild(label);

        for (i = 0; i < layers.length; i++) {
            var layer = layers[i];
            var color = colors[i];
            var item = document.createElement('div');
            var key = document.createElement('span');
            key.className = 'legend-key';
            key.style.backgroundColor = color;

            var value = document.createElement('span');
            value.innerHTML = layer;
            item.appendChild(key);
            item.appendChild(value);
            legend.appendChild(item);

        }
    }



//Function that displays a population density by highlighting blocks that have been reassigned,
//or in other words, the new school assignment is not equal to the current assignment
function diff_current_new()
{
    map.setPaintProperty("blocks", 'fill-color', ["case",
                ["==", ['number', ['get', 'currentSchool']],
                       300],
                "transparent",
                ["==", ['number', ['get', 'currentSchool']],
                       ['number', ['get', 'newSchool']]],
                "#19E2D1",
                ["!=", ['number', ['get', 'currentSchool']],
                       ['number', ['get', 'newSchool']]],
                "#ff150c",
                ["==", ['number', ['get', 'currentSchool']],
                       300],
                "transparent",
                "#7f8163"]);

     while (legend.hasChildNodes()) {
          legend.removeChild(legend.firstChild);
            }

        var layers = ["Assignment Didn't Change", 'Assignment Did Change'];
        var colors = ["#19E2D1", "#ff150c"];

        var label = document.createElement('label');
        label.innerHTML = 'Reassignments';
        legend.appendChild(label);

        for (i = 0; i < layers.length; i++) {
          var layer = layers[i];
          var color = colors[i];
          var item = document.createElement('div');
          var key = document.createElement('span');
          key.className = 'legend-key';
          key.style.backgroundColor = color;

          var value = document.createElement('span');
          value.innerHTML = layer;
          item.appendChild(key);
          item.appendChild(value);
          legend.appendChild(item);
        }
}


//Function that displays a population density by highlighting blocks with various
//colors based off of which race/ethnic group is a majority in the block
function raceVisual(givenMode)
{
    var label = document.createElement('label');
    if (givenMode === 'pre') {
        map.setPaintProperty("blocks", 'fill-color', ["case",

            ["==", ['number', ['get', 'currentSchool']],
                300],
            "transparent",
            [">=", ["/", ["number", ['get', 'AfroAmericanNum']],
                ["+", ["number", ['get', 'CaucasianNum']],
                    ["number", ['get', 'HispanicNum']],
                    ["number", ['get', 'OtherRaceNum']],
                    ["number", ['get', 'MultiRacialNum']],
                    ["number", ['get', 'AfroAmericanNum']]]],
                0.5],
            "#43fc0d",
            [">=", ["/", ["number", ['get', 'CaucasianNum']],
                ["+", ["number", ['get', 'CaucasianNum']],
                    ["number", ['get', 'HispanicNum']],
                    ["number", ['get', 'OtherRaceNum']],
                    ["number", ['get', 'MultiRacialNum']],
                    ["number", ['get', 'AfroAmericanNum']]]],
                0.5],
            "#0cebfc",
            [">=", ["/", ["number", ['get', 'HispanicNum']],
                ["+", ["number", ['get', 'CaucasianNum']],
                    ["number", ['get', 'HispanicNum']],
                    ["number", ['get', 'OtherRaceNum']],
                    ["number", ['get', 'MultiRacialNum']],
                    ["number", ['get', 'AfroAmericanNum']]]],
                0.5],
            "#ca0dfc",
            [">=", ["/", ["number", ['get', 'OtherRaceNum']],
                ["+", ["number", ['get', 'CaucasianNum']],
                    ["number", ['get', 'HispanicNum']],
                    ["number", ['get', 'OtherRaceNum']],
                    ["number", ['get', 'MultiRacialNum']],
                    ["number", ['get', 'AfroAmericanNum']]]],
                0.5],
            "#fc092e",
            [">=", ["/", ["number", ['get', 'MultiracialNum']],
                ["+", ["number", ['get', 'CaucasianNum']],
                    ["number", ['get', 'HispanicNum']],
                    ["number", ['get', 'OtherRaceNum']],
                    ["number", ['get', 'MultiRacialNum']],
                    ["number", ['get', 'AfroAmericanNum']]]],
                0.5],
            "#f37600",
            "#7f7f7f"
        ]);

        label.innerHTML = 'Population Density by Race Pre Model';
    }

    //This function and ones like it below
    // have a little twist: they only analyze the blocks
    // that have been reassigned (new != current)
    if (givenMode === 'post'){

        map.setPaintProperty("blocks", 'fill-color', ["case",
        ["==", ['number', ['get', 'currentSchool']],
                300],
        "transparent",
        ["all",  [">=", ["/", ["number", ['get', 'AfroAmericanNum']],
                              ["+", ["number", ['get', 'CaucasianNum']],
                                    ["number", ['get', 'HispanicNum']],
                                    ["number", ['get', 'OtherRaceNum']],
                                    ["number", ['get', 'MultiRacialNum']],
                                    ["number", ['get', 'AfroAmericanNum']]]],
                 0.5],
                 ["!=", ['number', ['get', 'currentSchool']],
                        ["number", ['get', 'newSchool']]]],
        "#43fc0d",
        ["all",  [">=", ["/", ["number", ['get', 'CaucasianNum']],
                              ["+", ["number", ['get', 'CaucasianNum']],
                                    ["number", ['get', 'HispanicNum']],
                                    ["number", ['get', 'OtherRaceNum']],
                                    ["number", ['get', 'MultiRacialNum']],
                                    ["number", ['get', 'AfroAmericanNum']]]],
                 0.5],
                 ["!=", ['number', ['get', 'currentSchool']],
                        ["number", ['get', 'newSchool']]]],
        "#0cebfc",
        ["all",  [">=", ["/", ["number", ['get', 'HispanicNum']],
                              ["+", ["number", ['get', 'CaucasianNum']],
                                    ["number", ['get', 'HispanicNum']],
                                    ["number", ['get', 'OtherRaceNum']],
                                    ["number", ['get', 'MultiRacialNum']],
                                    ["number", ['get', 'AfroAmericanNum']]]],
                 0.5],
                 ["!=", ['number', ['get', 'currentSchool']],
                        ["number", ['get', 'newSchool']]]],
        "#ca0dfc",
        ["all",  [">=", ["/", ["number", ['get', 'OtherRaceNum']],
                              ["+", ["number", ['get', 'CaucasianNum']],
                                    ["number", ['get', 'HispanicNum']],
                                    ["number", ['get', 'OtherRaceNum']],
                                    ["number", ['get', 'MultiRacialNum']],
                                    ["number", ['get', 'AfroAmericanNum']]]],
                 0.5],
                 ["!=", ['number', ['get', 'currentSchool']],
                        ["number", ['get', 'newSchool']]]],
        "#fc092e",
        ["all",  [">=", ["/", ["number", ['get', 'MultiRacialNum']],
                              ["+", ["number", ['get', 'CaucasianNum']],
                                    ["number", ['get', 'HispanicNum']],
                                    ["number", ['get', 'OtherRaceNum']],
                                    ["number", ['get', 'MultiRacialNum']],
                                    ["number", ['get', 'AfroAmericanNum']]]],
                 0.5],
                 ["!=", ['number', ['get', 'currentSchool']],
                        ["number", ['get', 'newSchool']]]],
        "#f37600",
        ["all", ["!=", ['number', ['get', 'currentSchool']],
                        ["number", ['get', 'newSchool']]],
                ["!=", ["/", ["number", ['get', 'AfroAmericanNum']],
                              ["+", ["number", ['get', 'CaucasianNum']],
                                    ["number", ['get', 'HispanicNum']],
                                    ["number", ['get', 'OtherRaceNum']],
                                    ["number", ['get', 'MultiRacialNum']],
                                    ["number", ['get', 'AfroAmericanNum']]]],
                 0.5],
                ["!=", ["/", ["number", ['get', 'CaucasianNum']],
                              ["+", ["number", ['get', 'CaucasianNum']],
                                    ["number", ['get', 'HispanicNum']],
                                    ["number", ['get', 'OtherRaceNum']],
                                    ["number", ['get', 'MultiRacialNum']],
                                    ["number", ['get', 'AfroAmericanNum']]]],
                 0.5],
                 ["!=", ["/", ["number", ['get', 'HispanicNum']],
                              ["+", ["number", ['get', 'CaucasianNum']],
                                    ["number", ['get', 'HispanicNum']],
                                    ["number", ['get', 'OtherRaceNum']],
                                    ["number", ['get', 'MultiRacialNum']],
                                    ["number", ['get', 'AfroAmericanNum']]]],
                 0.5],
                 ["!=", ["/", ["number", ['get', 'OtherRaceNum']],
                              ["+", ["number", ['get', 'CaucasianNum']],
                                    ["number", ['get', 'HispanicNum']],
                                    ["number", ['get', 'OtherRaceNum']],
                                    ["number", ['get', 'MultiRacialNum']],
                                    ["number", ['get', 'AfroAmericanNum']]]],
                 0.5],
                 ["!=", ["/", ["number", ['get', 'MultiRacialNum']],
                              ["+", ["number", ['get', 'CaucasianNum']],
                                    ["number", ['get', 'HispanicNum']],
                                    ["number", ['get', 'OtherRaceNum']],
                                    ["number", ['get', 'MultiRacialNum']],
                                    ["number", ['get', 'AfroAmericanNum']]]],
                 0.5]],
        "#7f7f7f",
        "rgba(255,243,143,0.98)"
    ]);

        label.innerHTML = 'Population Density by Race Post Model';
    }

     while (legend.hasChildNodes()) {
         legend.removeChild(legend.firstChild);
     }

     var layers = ['African American Majority', 'Caucasian Majority',
         'Hispanic Majority', 'Other Race Majority', 'Multiracial Majority', 'No Clear Majority'];
     var colors = ["#43fc0d", "#0cebfc", "#ca0dfc", "#fc092e", "#f37600", "#7f7f7f"];

     legend.appendChild(label);

     for (i = 0; i < layers.length; i++) {
         var layer = layers[i];
         var color = colors[i];
         var item = document.createElement('div');
         var key = document.createElement('span');
         key.className = 'legend-key';
         key.style.backgroundColor = color;

         var value = document.createElement('span');
         value.innerHTML = layer;
         item.appendChild(key);
         item.appendChild(value);
         legend.appendChild(item);
     }
}


// Function that displays a population density by grades
function gradesVisual(givenMode)
{
    var label = document.createElement('label');
    if (givenMode === 'pre') {
        map.setPaintProperty("blocks", 'fill-color', ["case",
            [">=", ["/", ["number", ["get", 'k-2']],
                ["+", ["number", ["get", '3-5']],
                    ["number", ["get", 'k-2']],
                    ["number", ["get", '6-8']]]],
                0.5],
            "#fc1515",
            [">=", ["/", ["number", ["get", '3-5']],
                ["+", ["number", ["get", '3-5']],
                    ["number", ["get", 'k-2']],
                    ["number", ["get", '6-8']]]],
                0.5],
            "#ffdb06",
            [">=", ["/", ["number", ["get", '6-8']],
                ["+", ["number", ["get", '3-5']],
                    ["number", ["get", 'k-2']],
                    ["number", ["get", '6-8']]]],
                0.5],
            "#39ff10",
            ["==", ['number', ['get', 'currentSchool']],
                300],
            "transparent",

            ["all", ["!=", ["/", ["number", ["get", 'k-2']],
                ["+", ["number", ["get", '3-5']],
                    ["number", ["get", 'k-2']],
                    ["number", ["get", '6-8']]]],
                0.5],
                ["!=", ["/", ["number", ["get", '3-5']],
                    ["+", ["number", ["get", '3-5']],
                        ["number", ["get", 'k-2']],
                        ["number", ["get", '6-8']]]],
                    0.5],
                ["!=", ["/", ["number", ["get", '6-8']],
                    ["+", ["number", ["get", '3-5']],
                        ["number", ["get", 'k-2']],
                        ["number", ["get", '6-8']]]],
                    0.5]],
            "rgba(155,140,157,0.74)",
            "#0809a3"
        ]);
        label.innerHTML = 'Population Density by Grades Pre Model';
    }

    if (givenMode === 'post'){

         map.setPaintProperty("blocks", 'fill-color', ["case",
                ["==", ['number', ['get', 'currentSchool']],
                       300],
                "transparent",
                ["all",  [">=", ["/", ["number", ['get', 'k-2']],
                              ["+", ["number", ['get', 'k-2']],
                                    ["number", ['get', '3-5']],
                                    ["number", ['get', '6-8']]]],
                 0.5],
                 ["!=", ['number', ['get', 'currentSchool']],
                        ["number", ['get', 'newSchool']]]],
        "#fc1515",
        ["all",  [">=", ["/", ["number", ['get', '3-5']],
                              ["+", ["number", ['get', 'k-2']],
                                    ["number", ['get', '3-5']],
                                    ["number", ['get', '6-8']]]],
                 0.5],
                 ["!=", ['number', ['get', 'currentSchool']],
                        ["number", ['get', 'newSchool']]]],
        "#ffdb06",
        ["all",  [">=", ["/", ["number", ['get', '6-8']],
                              ["+", ["number", ['get', 'k-2']],
                                    ["number", ['get', '3-5']],
                                    ["number", ['get', '6-8']]]],
                 0.5],
                 ["!=", ['number', ['get', 'currentSchool']],
                        ["number", ['get', 'newSchool']]]],
        "#39ff10",
        ["all", ["!=", ['number', ['get', 'currentSchool']],
                        ["number", ['get', 'newSchool']]],
                ["!=", ["/", ["number", ['get', 'k-2']],
                              ["+", ["number", ['get', 'k-2']],
                                    ["number", ['get', '3-5']],
                                    ["number", ['get', '6-8']]]],
                 0.5],
                ["!=", ["/", ["number", ['get', '3-5']],
                              ["+", ["number", ['get', 'k-2']],
                                    ["number", ['get', '3-5']],
                                    ["number", ['get', '6-8']]]],
                 0.5],
                ["!=", ["/", ["number", ['get', '6-8']],
                              ["+", ["number", ['get', 'k-2']],
                                    ["number", ['get', '3-5']],
                                    ["number", ['get', '6-8']]]],
                 0.5]],
        "#7f7f7f",
        "rgba(46,232,197,0.38)"
    ]);
          label.innerHTML = 'Population Density by Grades Post Model';
    }

    while (legend.hasChildNodes()) {
          legend.removeChild(legend.firstChild);
            }

        var layers = ['K-2 Majority', '3-5 Majority', '6-8 Majority', 'No Clear Majority'];
        var colors = ["#fc1515", "#ffdb06", "#39ff10", "#7f7f7f"];

        legend.appendChild(label);

        for (i = 0; i < layers.length; i++) {
          var layer = layers[i];
          var color = colors[i];
          var item = document.createElement('div');
          var key = document.createElement('span');
          key.className = 'legend-key';
          key.style.backgroundColor = color;

          var value = document.createElement('span');
          value.innerHTML = layer;
          item.appendChild(key);
          item.appendChild(value);
          legend.appendChild(item);
        }

}


// Function that displays a population density by free/reduced lunch
function frlVisual(term)
{
    var label = document.createElement('label');
    if (term === "pre") {
        map.setPaintProperty("blocks", 'fill-color', ["case",
            ["==", ['number', ['get', 'currentSchool']],
                300],
            "transparent",
            [">=", ["/", ['number', ['get', 'frlNum']],
                ['number', ['get', 'totalStudentsNum']]],
                0.5],
            "#ffdb06",
            "#2cd70c"]
        );
        label.innerHTML = 'Population Density by Free/Reduced Lunch Pre Model';
    }
    if (term === "post")
    {
        map.setPaintProperty("blocks", 'fill-color', ["case",
            ["==", ['number', ['get', 'currentSchool']],
                   300],
            "transparent",
            ["all", ["!=", ['number', ['get', 'currentSchool']],
                           ['number', ['get', 'newSchool']]],
                    [">=", ["/", ['number', ['get', 'frlNum']],
                                 ['number', ['get', 'totalStudentsNum']]],
                           0.5]],
            "#ffdb06",
            ["all", ["!=", ['number', ['get', 'currentSchool']],
                           ['number', ['get', 'newSchool']]],
                    ["!=", ["/", ['number', ['get', 'frlNum']],
                                 ['number', ['get', 'totalStudentsNum']]],
                           0.5]],
            "#2cd70c",
            "rgba(209,42,0,0.54)"
    ]);
        label.innerHTML = 'Population Density by Free/Reduced Lunch Post Model';
    }

    while (legend.hasChildNodes()) {
          legend.removeChild(legend.firstChild);
            }

        var layers = ['Majority', 'No Majority'];
        var colors = ["#ffdb06", "#2cd70c"];

        legend.appendChild(label);

        for (i = 0; i < layers.length; i++) {
          var layer = layers[i];
          var color = colors[i];
          var item = document.createElement('div');
          var key = document.createElement('span');
          key.className = 'legend-key';
          key.style.backgroundColor = color;

          var value = document.createElement('span');
          value.innerHTML = layer;
          item.appendChild(key);
          item.appendChild(value);
          legend.appendChild(item);
        }
}


// Function that displays a population density by TWI
function twiVisual(givenMode)
{
    var label = document.createElement('label');
    if (givenMode === 'pre'){

        map.setPaintProperty('blocks', 'fill-color', ["case",
            ['==', ['number', ['get', 'currentSchool']],
                   300],
            "transparent",
            [">=", ['/', ['number', ['get', 'twiEnglish']],
                         ['+', ['number', ['get', 'twiOther']],
                               ['number', ['get', 'twiEnglish']],
                               ['number', ['get', 'twiSpanish']]]],
                   0.5],
            "#0809db",
            [">=", ['/', ['number', ['get', 'twiOther']],
                         ['+', ['number', ['get', 'twiOther']],
                               ['number', ['get', 'twiEnglish']],
                               ['number', ['get', 'twiSpanish']]]],
                   0.5],
            "#fa0eaa",
            [">=", ['/', ['number', ['get', 'twiSpanish']],
                         ['+', ['number', ['get', 'twiOther']],
                               ['number', ['get', 'twiEnglish']],
                               ['number', ['get', 'twiSpanish']]]],
                   0.5],
            "#ffe464",
            "#7f7f7f"
        ]);
        label.innerHTML = 'Population Density by TWI Pre Model';
    }

    if (givenMode === 'post')
    {
        map.setPaintProperty('blocks', 'fill-color', ["case",
            ["==", ['number', ['get', 'currentSchool']],
                   300],
            "transparent",
            ["all", ['!=', ['number', ['get', 'currentSchool']],
                           ['number', ['get', 'newSchool']]],
                    [">=", ['/', ['number', ['get', 'twiEnglish']],
                         ['+', ['number', ['get', 'twiOther']],
                               ['number', ['get', 'twiEnglish']],
                               ['number', ['get', 'twiSpanish']]]],
                   0.5]],
            "#0809db",
            ["all", ['!=', ['number', ['get', 'currentSchool']],
                           ['number', ['get', 'newSchool']]],
                    [">=", ['/', ['number', ['get', 'twiOther']],
                         ['+', ['number', ['get', 'twiOther']],
                               ['number', ['get', 'twiEnglish']],
                               ['number', ['get', 'twiSpanish']]]],
                   0.5]],
            "#fa0eaa",
            ["all", ['!=', ['number', ['get', 'currentSchool']],
                           ['number', ['get', 'newSchool']]],
                    [">=", ['/', ['number', ['get', 'twiSpanish']],
                         ['+', ['number', ['get', 'twiOther']],
                               ['number', ['get', 'twiEnglish']],
                               ['number', ['get', 'twiSpanish']]]],
                   0.5]],
            "#ffe464",
            ["all", ["!=", ['number', ['get', 'currentSchool']],
                           ['number', ['get', 'newSchool']]],
                    ["!=", ['/', ['number', ['get', 'twiEnglish']],
                         ['+', ['number', ['get', 'twiOther']],
                               ['number', ['get', 'twiEnglish']],
                               ['number', ['get', 'twiSpanish']]]],
                   0.5],
                    ["!=", ['/', ['number', ['get', 'twiOther']],
                         ['+', ['number', ['get', 'twiOther']],
                               ['number', ['get', 'twiEnglish']],
                               ['number', ['get', 'twiSpanish']]]],
                   0.5],
                    ["!=", ['/', ['number', ['get', 'twiSpanish']],
                         ['+', ['number', ['get', 'twiOther']],
                               ['number', ['get', 'twiEnglish']],
                               ['number', ['get', 'twiSpanish']]]],
                   0.5]],
            "#7f7f7f",
            "rgba(49,255,13,0.53)"
        ]);
        label.innerHTML = 'Population Density by TWI Post Model';
    }

    while (legend.hasChildNodes()) {
         legend.removeChild(legend.firstChild);
     }

     var layers = ['TWI English Majority', 'TWI Other Majority', 'TWI Spanish Majority', 'No Clear Majority'];
     var colors = ["#0809db", "#fa0eaa", "#ffe464", "#7f7f7f"];

     legend.appendChild(label);

     for (i = 0; i < layers.length; i++) {
         var layer = layers[i];
         var color = colors[i];
         var item = document.createElement('div');
         var key = document.createElement('span');
         key.className = 'legend-key';
         key.style.backgroundColor = color;

         var value = document.createElement('span');
         value.innerHTML = layer;
         item.appendChild(key);
         item.appendChild(value);
         legend.appendChild(item);
     }
}


//Slider modification
// And all of the code that interacts with
// the slider
    var years = [
        '2019',
        '2020',
        '2021',
        '2022',
        '2023',
    ];

    document.getElementById('slider').addEventListener('input', function (e) {
        var year = parseInt(e.target.value, 10);
        sliderModify(year);
    });

    function sliderModify(year) {
        map.setPaintProperty("blocks", "fill-color", ["case",
            ["<", ["number", ['get', years[year]]],
                5], "#EAF2F8",
            ["<", ["number", ['get', years[year]]],
                10], "#A9CCE3",
            ["<", ["number", ['get', years[year]]],
                15], "#5499C7",
            ["<", ["number", ['get', years[year]]],
                20], "#2471A3",
            /* > 20 */  "#1A5276"]);
        // Set the label to the month
        document.getElementById('month').textContent = years[year];
    }


</script>

 
